<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.carsale.mapper.VehicleMapper">

    <resultMap id="BaseResultMap" type="com.carsale.entity.Vehicle">
        <id column="vin" property="vin" jdbcType="VARCHAR"/>
        <result column="model_id" property="modelId" jdbcType="INTEGER"/>
        <result column="purchase_price" property="purchasePrice" jdbcType="DECIMAL"/>
        <result column="sale_price" property="salePrice" jdbcType="DECIMAL"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="warehouse_location" property="warehouseLocation" jdbcType="VARCHAR"/>
        <result column="purchase_date" property="purchaseDate" jdbcType="DATE"/>
        <result column="sale_date" property="saleDate" jdbcType="DATE"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <resultMap id="VehicleWithDetailsResultMap" type="com.carsale.entity.Vehicle" extends="BaseResultMap">
        <association property="carModel" javaType="com.carsale.entity.CarModel">
            <id column="cm_id" property="modelId"/>
            <result column="model_name" property="modelName"/>
            <result column="cm_year" property="year"/>
            <result column="engine_type" property="engineType"/>
            <result column="transmission" property="transmission"/>
            <result column="fuel_type" property="fuelType"/>
            <result column="guide_price" property="guidePrice"/>
        </association>
        <association property="manufacturer" javaType="com.carsale.entity.Manufacturer">
            <id column="m_id" property="manufacturerId"/>
            <result column="manufacturer_name" property="manufacturerName"/>
        </association>
    </resultMap>

    <select id="selectPageWithDetails" resultMap="VehicleWithDetailsResultMap">
        SELECT
        v.*,
        cm.model_id AS cm_id,
        cm.model_name,
        cm.year AS cm_year,
        cm.engine_type,
        cm.transmission,
        cm.fuel_type,
        cm.guide_price,
        m.manufacturer_id AS m_id,
        m.manufacturer_name
        FROM vehicle v
        LEFT JOIN car_model cm ON v.model_id = cm.model_id
        LEFT JOIN manufacturer m ON cm.manufacturer_id = m.manufacturer_id
        WHERE 1=1
        <if test="vin != null and vin != ''">
            AND v.vin LIKE CONCAT('%', #{vin}, '%')
        </if>
        <if test="status != null and status != ''">
            AND v.status = #{status}
        </if>
        <if test="modelId != null">
            AND v.model_id = #{modelId}
        </if>
        ORDER BY v.created_at DESC
    </select>

    <select id="selectByModelId" resultMap="BaseResultMap">
        SELECT * FROM vehicle WHERE model_id = #{modelId} ORDER BY created_at DESC
    </select>

    <select id="selectCurrentInventory" resultMap="VehicleWithDetailsResultMap">
        SELECT
            v.*,
            cm.model_id AS cm_id,
            cm.model_name,
            cm.year AS cm_year,
            m.manufacturer_id AS m_id,
            m.manufacturer_name
        FROM vehicle v
                 LEFT JOIN car_model cm ON v.model_id = cm.model_id
                 LEFT JOIN manufacturer m ON cm.manufacturer_id = m.manufacturer_id
        WHERE v.status = 'in_stock'
        ORDER BY v.created_at DESC
    </select>

    <update id="updateStatusByVin">
        UPDATE vehicle SET status = #{status}, updated_at = NOW() WHERE vin = #{vin}
    </update>

    <select id="selectDashboardStats" resultType="java.util.Map">
        SELECT
                (SELECT COUNT(*) FROM vehicle) AS totalVehicles,
                (SELECT COUNT(*) FROM vehicle WHERE status IN ('in_stock', 'in_transit')) AS inStockVehicles,
                (SELECT COUNT(*) FROM vehicle WHERE status = 'sold') AS totalSales,
                (SELECT IFNULL(SUM(sale_price - purchase_price), 0) FROM vehicle WHERE status = 'sold') AS totalProfit
    </select>

    <select id="selectAvailableVehicles" resultMap="VehicleWithDetailsResultMap">
        SELECT
            v.*,
            cm.model_id AS cm_id,
            cm.model_name,
            cm.year AS cm_year,
            cm.engine_type,
            cm.transmission,
            cm.fuel_type,
            cm.guide_price,
            m.manufacturer_id AS m_id,
            m.manufacturer_name
        FROM vehicle v
                 LEFT JOIN car_model cm ON v.model_id = cm.model_id
                 LEFT JOIN manufacturer m ON cm.manufacturer_id = m.manufacturer_id
        WHERE v.status = 'in_stock'
        ORDER BY v.created_at DESC
    </select>

</mapper>